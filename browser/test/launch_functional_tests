# sh launch_functional_tests functional/test_*rb

FUNCTIONAL_TESTS=$*

rename_reports_in() {
    dir="$1"
    b="$2"
    if [ "$b" = "." ]; then
        b="default"
    else
        b=$(echo "$b" | tr '/' '-')
    fi
    for file in $1/*.xml; do
        filename=$(basename -s .xml $file)
        mv $file $dir/$filename-$b.xml
    done
}

rm -f test/*.xml
EXIT=0
if [ -z "$FUNCTIONAL_CLIENT_BROWSER_PATH" ]; then
    FUNCTIONAL_CLIENT_BROWSER_PATH="."
fi
for browser in $FUNCTIONAL_CLIENT_BROWSER_PATH; do
    for file in $FUNCTIONAL_TESTS; do
        echo "\033[34m===" $file "\033[0m"
        if [ ${#browser} -gt 1 ]; then
            export WATIR_BROWSER_PATH="$browser"
        fi
        ruby -I functional $file;
        TMP_EXIT=$?
        if [ $TMP_EXIT -ne 0 ]; then
            echo "\033[31m===" $file ": FAILED \033[0m"
            EXIT=$TMP_EXIT
        else
            echo "\033[32m===" $file ": ok \033[0m"
        fi
        rename_reports_in test/reports/ "$browser"
        mv test/reports/*.xml test/
        echo
    done
done
exit $EXIT
