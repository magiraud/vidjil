{{extend 'db_layout.html'}}

<div>
    <div class="db_block">
        <div class="db_block_left">
            search
            <input id="db_filter_input" type="text" value="{{=request.vars["filter"]}}"  onchange="db.call('my_account/index', {'filter' : this.value, 'group_ids': {{=group_ids}}  } )"
            onfocus="new VidjilAutoComplete().setupTags(this);"
            data-needs-atwho="true" data-keys="{{=involved_group_ids}}">
        </div>
    </div>
    <div class="db_block">
        {{ for role in result: }}
            <div id="{{=role}}_info" class="set_group">
                <div class="set_group_header">
                    {{=role}} ({{=result[role]['permissions']}})
                    <hr>
                </div>
                {{ for set_type in ['patient', 'run', 'set']: }}
                    {{ r = result[role][set_type]['count'] }}
                    <div class="set_cell margined-bottom">
                        <span class="button_token {{=r['sample_type']}}_token">{{=set_type}}s</span>:
                        <span class="{{=set_type}}_num_sets">{{=r['num_sets']}}</span>
                        <span class="{{=set_type}}_num_samples">(samples: {{=r['num_samples']}})</span>
                        <span>/ last month:</span>
                        <span>jobs: {{=result[role][set_type]['num_jobs']}} {{=result[role][set_type]['statuses']}}</span>
                    </div>
                    {{pass}}
                <div class="set_data margined-bottom">
                    {{ for tag in result[role]['tags']: }}
                        <a onclick="event.preventDefault();event.stopPropagation();db.callLinkable($(this))" href="/my_account/index" class="tag-link" data-linkable-type="tag" data-linkable-target-param="filter" data-linkable-name="#{{=tag.split(' ')[0]}}">#{{=tag}}</a>
                        {{pass}}
                </div>
                <div class="set_data">
                    <div>fuses:</div>
                {{ for fuse in result[role]['fuses']: }}
                    <div class="analysis_button">
                        <span class="button button_token {{=fuse[3]}}_token">
                            <a href="https://localhost/?sample_set_id={{=fuse[1]}}&config={{=fuse[2]}}">{{=fuse[4]}}: {{=fuse[0]}}</a>
                        </span>
                    </div>
                    {{pass}}
                </div>
                <div class="set_data">
                    <div>analyses:</div>
                {{ for analysis in result[role]['analyses']: }}
                    <div class="analysis_button">
                        <span class="button button_token {{=analysis[1]}}_token">
                            <span onclick="db.call('sample_set/index', {'id': {{=analysis[0]}}, 'config_id': -1})">{{=analysis[2]}}</span>
                        </span>
                    </div>
                    {{pass}}
                </div>
            </div>
            {{pass}}
    </div>
</div>
